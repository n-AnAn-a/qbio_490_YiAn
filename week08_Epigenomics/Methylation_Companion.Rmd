---
title: "Intro to Epigenomics"
author: Wade Boohar
date: 11/03/24
updated: 03/07/24
---


```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("/home1/yianxu/490_cluster/analysis_data"))
```

Package Download and Data-cleaning
```{r}
if (!require("sesameData", quietly = TRUE))
BiocManager::install("sesameData")

if (!require("sesame", quietly = TRUE))
BiocManager::install("sesame")

if (!require("limma", quietly = TRUE))
BiocManager::install("limma")
install.packages("data.table")
install.packages("ggplot2")

```


Load in all necessary packages
```{r}
library(TCGAbiolinks)
library(sesame)
library(sesameData)
library(limma)
library(data.table)
library(ggplot2)

```

```{r}
# query <- GDCquery(project = "TCGA-BRCA",
#                   data.category = "DNA Methylation",
#                   data.type = "Methylation Beta Value",
#                   platform = "Illumina Human Methylation 450",
#                   data.format = "Dataframe")
# GDCdownload(query)
# methylation450 <- GDCprepare(query)
```

```{r}
# methylation_clinical <- as.data.frame(methylation450@colData)
# betas <- as.data.frame(methylation450@assays@data@listData)
# cpg_sites <- as.data.frame(methylation450@rowRanges@elementMetadata)
# 
# column_mask <- ifelse(colnames(methylation_clinical) %in% c('treatments', 'primary_site', 'disease_type','sites_of_involvement'), F, T)
# 
# methylation_clinical <- methylation_clinical[,column_mask]
# write.csv(methylation_clinical, 'brca_methylation_clinical.csv')
# 
# 
# site_mask <- !grepl('-', cpg_sites$gene) & !grepl(';', cpg_sites$gene) & !is.na(cpg_sites$gene) & complete.cases(betas)
# betas <- betas[site_mask,]
# cpg_sites <- cpg_sites[site_mask,]
# 
# write.csv(betas, 'brca_methylation_betas.csv')
# write.csv(cpg_sites, 'brca_cpg_sites.csv')
```

```{r}
# methylation_clinical <- read.csv('brca_methylation_clinical.csv', row.names = 1)
# betas <- read.csv('brca_methylation_betas.csv', row.names = 1)
# cpg_sites <- read.csv('brca_cpg_sites.csv', row.names = 1)
```

```{r}
methylation_clinical <- read.csv("/project/rohs_1070/analysis_data/brca_methylation_clinical.csv", row.names = 1)

cpg_sites <- read.csv("/project/rohs_1070/analysis_data/brca_cpg_sites.csv", row.names = 1)



betas <- fread('/project/rohs_1070/analysis_data/brca_methylation_betas.csv', showProgress = TRUE)

betas <- as.data.frame(betas)
rownames(betas) <- betas[[1]]
betas[[1]] <- NULL
```

(1) Naive Differential Methylation
```{r}
#masking out NAs
na_mask <- !is.na(methylation_clinical$age_at_diagnosis)
methylation_clinical <- methylation_clinical[na_mask,]
betas_clean <- betas[,na_mask]

median <- median(methylation_clinical$age_at_diagnosis)

methylation_clinical$age_category <- ifelse(methylation_clinical$age_at_diagnosis >= median, "old", "young")

#fitting linear models using a "target value"
young_mask <- methylation_clinical$age_category == "young"

methylation_clinical$ages <- !young_mask

mval <- t(apply(betas_clean, 1, function(x) log2(x/(1-x)))) 
#mvalue is another statistic for methylation, centered at 0 and ranges from -1 to 1

design <- model.matrix(~ages, data = methylation_clinical)
fit <- lmFit(mval, design)
fit2 <- eBayes(fit)
```

```{r}
#Extracting model into dataframe
dat <- data.frame(foldchange = fit[["coefficients"]][,2], logPvalue =  -log10(p.adjust(fit2[["p.value"]][,2],method='BY')), geneName = cpg_sites$gene)
dat$threshold <- as.factor(abs(dat$foldchange) < 1)

#Visualization
cols <- c("TRUE" = "grey", "FALSE" = "blue")
ggplot(data=dat, aes(x=foldchange, y = logPvalue, color=threshold)) +
  geom_point(alpha=.2, size=0.6) +
  scale_colour_manual(values = cols) +
  geom_vline(xintercept = 1, colour="#990000", linetype="dashed") + 
  geom_vline(xintercept = - 1, colour="#990000", linetype="dashed") +
  geom_hline(yintercept = 2, colour = "#990000", linetype="dashed") +
  theme(legend.position="none") +
  xlab("Fold Change") +
  ylab("-log10 p value") +
  theme_bw() +
  theme(legend.position = "none")
```
The volcano plot shows that only a few CpG sites differ strongly between metastatic and non-metastatic patients, while most sites show very little change. This suggests that large methylation differences are limited to a small set of loci. However, we cannot say that metastasis has no methylation effects, because this simple comparison does not control for factors like tumor purity or patient differences. The plot shows basic associations only, not definite biological causes.

(2) Direct comparison of methylation status to transcriptional activity

#...INSERT DESeq2 Stuff here to generate 'results'...
```{r}
## (2) Direct comparison of methylation status to transcriptional activity
##     Goal: create `results` with columns gene_name, log2FoldChange, padj

# install + load DESeq2 (quietly)
if (!requireNamespace("DESeq2", quietly = TRUE)) BiocManager::install("DESeq2")
library(DESeq2)

# A) Download & prepare TCGA-BRCA RNA-seq counts (HTSeq - Counts)
query_rna <- GDCquery(
  project       = "TCGA-BRCA",
  data.category = "Transcriptome Profiling",
  data.type     = "Gene Expression Quantification",
  workflow.type = "STAR - Counts"
)
#GDCdownload(query_rna)
rna_se <- GDCprepare(query_rna)  # SummarizedExperiment

# B) Pull out matrices/data.frames used later (kept simple)
rna_counts  <- SummarizedExperiment::assay(rna_se)                 # counts (genes x samples)
rna_genesdf <- as.data.frame(SummarizedExperiment::rowData(rna_se))# gene meta
rna_clinical<- as.data.frame(SummarizedExperiment::colData(rna_se))# sample meta

# gene symbols column (fallback to rownames if absent)
sym_col <- intersect(c("gene_name","external_gene_name","symbol"), colnames(rna_genesdf))
if (length(sym_col) == 0) {
  rna_genes <- data.frame(gene_name = rownames(rna_counts), stringsAsFactors = FALSE)
  rownames(rna_genes) <- rownames(rna_counts)
} else {
  rna_genes <- data.frame(gene_name = rna_genesdf[[sym_col[1]]], stringsAsFactors = FALSE)
  rownames(rna_genes) <- rownames(rna_genesdf)
}

# C) Keep only Primary solid Tumor vs Metastatic samples (simple 2-group comparison)
keep_cols <- rna_clinical$definition %in% c("Primary solid Tumor","Metastatic")
rna_counts   <- rna_counts[, keep_cols, drop = FALSE]
rna_clinical <- rna_clinical[keep_cols, , drop = FALSE]

# D) Filter very low-count genes (simple rule)
keep_genes <- rowSums(rna_counts) >= 20
rna_counts <- rna_counts[keep_genes, , drop = FALSE]
rna_genes  <- rna_genes [keep_genes, , drop = FALSE]

# E) Build DESeq2 object with condition factor (Primary as baseline)
condition <- factor(
  ifelse(rna_clinical$definition == "Metastatic", "Metastatic", "Primary solid Tumor"),
  levels = c("Primary solid Tumor","Metastatic")
)
dds <- DESeqDataSetFromMatrix(
  countData = rna_counts,
  colData   = data.frame(condition = condition, row.names = colnames(rna_counts)),
  design    = ~ condition
)

# F) Run DESeq2 and extract contrast (Metastatic vs Primary)
dds <- DESeq(dds)
res <- results(dds, contrast = c("condition","Metastatic","Primary solid Tumor"), alpha = 0.05)

# G) Turn into the `results` data frame expected by the notebook
res_df <- as.data.frame(res)
res_df$gene_name <- rna_genes$gene_name[match(rownames(res_df), rownames(rna_genes))]

# keep useful columns; do not change names used later
results <- res_df[, c("gene_name","log2FoldChange","padj")]
rownames(results) <- NULL

results
```

```{r}
#you can also try looking at "upregulated" or "hypermethylated" !
downregulated <- results[(results$log2FoldChange < 3), 'gene_name']
hypomethylated <- dat[dat$foldchange < -1, 'geneName']
interest_genes <- intersect(downregulated, hypomethylated)
```


(Extra) Making Boxplots
```{r}
rna_clinical<- as.data.frame(SummarizedExperiment::colData(rna_se))# sample meta
rna_counts  <- SummarizedExperiment::assay(rna_se)                 # counts (genes x samples)

GENE<-"SCTR"

gene_counts_mask <- rna_genes$gene_name == GENE
gene_betas_mask <- cpg_sites$gene == GENE

rna_clinical_tumor <- rna_clinical$definition == "Primary solid Tumor"
methylation_clinical_tumor <- methylation_clinical$definition == "Primary solid Tumor"

rna_clinical_normal <- rna_clinical$definition == "Solid Tissue Normal"
methylation_clinical_normal <- methylation_clinical$definition == "Solid Tissue Normal"

rna_tumor <- as.numeric(rna_counts[gene_counts_mask, rna_clinical_tumor])
methylation_tumor <- (betas[gene_betas_mask, methylation_clinical_tumor])

rna_normal <- as.numeric(rna_counts[gene_counts_mask, rna_clinical_normal])
methylation_normal <- (betas[gene_betas_mask, methylation_clinical_normal])
```

```{r}
boxplot(rna_normal, rna_tumor, xlab='Group', ylab='Counts', names=c('Normal', 'Tumor'))
```
The boxplot shows that this gene has noticeably different expression levels in tumor samples compared to normal tissue. Tumor samples tend to have higher expression and much greater variability. However, this plot compares tumor vs. normal, not metastatic vs. non-metastatic tumors, so it does not tell us anything about metastasis. Because of that, we cannot draw conclusions about how this gene behaves across metastatic states—only that tumor and normal tissues differ in expression.

3. On the UCSC Genome Browser, SCTR, CCND2, and FGF2 all have clear CpG islands near their promoters or first exons, and the gene tracks show where key coding regions and protein domains sit relative to these CpG-rich regions. This means that if methylation changes at these CpG sites between metastatic and non-metastatic TCGA BRCA tumors, it could realistically change transcription of the function, and in turn affect tumor behavior. However, the UCSC plots do not show TCGA methylation values or label which samples are metastatic vs non-metastatic. So we cannot say that metastasis actually changes methylation of these genes in TCGA BRCA but the genomic layout makes such regulation biologically plausible.

Kang et al. (2015) studied SCTR in normal breast cells and MCF-7 breast cancer cells and showed that promoter methylation reduces SCTR expression in normal cells, while forced SCTR expression in cancer cells increases cell proliferation and migration. This supports the idea that methylation in the SCTR promoter region can influence aggressive cancer behaviors that are related to metastasis. At the same time, their experiments did not directly compare metastatic vs non-metastatic patient tumors, so they didn’t prove that SCTR methylation is different between those two TCGA groups.